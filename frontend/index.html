<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CodeShare</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chat, #auth, #upload { margin-bottom: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>Bem-vindo ao CodeShare!</h1>

    <!-- Autenticação -->
    <div id="auth">
        <h2>Login/Registro</h2>
        <input id="username" placeholder="Nome de usuário">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Senha">
        <button onclick="register()">Registrar</button>
        <button onclick="login()">Login</button>
    </div>

    <!-- Upload -->
    <div id="upload">
        <h2>Upload de Software</h2>
        <input id="title" placeholder="Título">
        <input id="description" placeholder="Descrição">
        <select id="category">
            <option value="pc-utilities">PC Utilities</option>
            <option value="pc-games">PC Games</option>
            <option value="pc-security">PC Security</option>
            <option value="android-social">Android Social</option>
            <option value="android-games">Android Games</option>
            <option value="android-modified">Android Modified</option>
            <option value="script-python">Script Python</option>
            <option value="script-javascript">Script JavaScript</option>
            <option value="script-batch">Script Batch</option>
            <option value="script-powershell">Script PowerShell</option>
        </select>
        <select id="license">
            <option value="free">Free</option>
            <option value="open-source">Open Source</option>
            <option value="shareware">Shareware</option>
            <option value="modified">Modified</option>
        </select>
        <input id="tags" placeholder="Tags (separadas por vírgula)">
        <input id="file" type="file">
        <button onclick="uploadFile()">Enviar Arquivo</button>
    </div>

    <!-- Chat -->
    <div id="chat">
        <h2>Chat</h2>
        <input id="message" placeholder="Digite uma mensagem">
        <button onclick="sendMessage()">Enviar</button>
        <div id="messages"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let token = null;
        const socket = io({ auth: { token } });

        socket.on('connect', () => {
            console.log('Conectado ao WebSocket');
            socket.emit('join-chat', { username: 'Anônimo' });
        });

        socket.on('chat_history', (messages) => {
            const messagesDiv = document.getElementById('messages');
            messages.forEach(msg => {
                messagesDiv.innerHTML += `<p><strong>${msg.user.username}</strong>: ${msg.message}</p>`;
            });
        });

        socket.on('new_message', (data) => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += `<p><strong>${data.user.username}</strong>: ${data.message}</p>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        socket.on('error_message', (msg) => {
            alert('Erro: ' + msg);
        });

        async function register() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password })
            });
            const data = await response.json();
            alert(data.message || data.error);
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (data.token) {
                token = data.token;
                socket.auth.token = token;
                socket.disconnect().connect();
                alert('Login bem-sucedido!');
            } else {
                alert(data.error);
            }
        }

        async function uploadFile() {
            if (!token) return alert('Faça login primeiro');
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('category', document.getElementById('category').value);
            formData.append('license', document.getElementById('license').value);
            formData.append('tags', document.getElementById('tags').value.split(','));
            formData.append('file', document.getElementById('file').files[0]);
            const response = await fetch('/api/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await response.json();
            alert(data.message || data.error);
        }

        function sendMessage() {
            if (!token) return alert('Faça login primeiro');
            const message = document.getElementById('message').value;
            socket.emit('send_message', message);
            document.getElementById('message').value = '';
        }
    </script>
</body>
</html>